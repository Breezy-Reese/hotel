<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Room - Hotel Paradise</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1, h2 { text-align: center; }
    .room-card { 
      background: white; padding: 15px; border-radius: 10px; width: 250px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 10px; text-align: center; 
      display: inline-block; 
    }
    .room-card button { padding: 5px 10px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; }
    .room-card button.available { background: #28a745; color: white; }
    .room-card button.available:hover { background: #1e7e34; }
    .room-card button.booked { background: gray; color: white; cursor: not-allowed; }
    .nav { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .nav a { text-decoration: none; color: #333; }
    .nav a.active { font-weight: bold; color: #28a745; }

    /* Modal styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
             background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; position: relative; }
    .modal-content label { display: block; margin: 10px 0 5px; }
    .modal-content input { width: 100%; padding: 5px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    .modal-content button { width: 100%; padding: 7px; border: none; border-radius: 5px; cursor: pointer; background: #28a745; color: white; font-weight: bold; }
    .close-btn { position: absolute; top: 5px; right: 10px; cursor: pointer; font-size: 18px; color: #333; }
  </style>
</head>
<body>
<header>
  <nav class="nav">
    <strong>üè® Hotel Paradise</strong>
    <a href="index.html">Home</a>
    <a href="booking.html" class="active">Book a Room</a>
    <a href="services.html">Services</a>
  </nav>
  <h1>Book a Room</h1>
</header>

<main>
  <div id="availableRooms"></div>
</main>

<!-- Booking Form Modal -->
<div id="bookingModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3 id="modalRoomName">Room Name</h3>
    <input type="text" id="guestName" placeholder="Full Name" required>
    <input type="email" id="guestEmail" placeholder="Email" required>
    <label for="checkin">Check-in</label>
    <input type="date" id="checkin" required>
    <label for="checkout">Check-out</label>
    <input type="date" id="checkout" required>
    <button onclick="submitBooking()">Book & Pay</button>
  </div>
</div>

<script>
const USD_TO_KES = 150;
let selectedRoomId = null;

async function fetchRooms() {
  try {
    const res = await fetch('http://localhost:4242/rooms');
    const data = await res.json();
    const rooms = Array.isArray(data) ? data : data.rooms;

    if (rooms && rooms.length > 0) {
      displayRooms(rooms);
    } else {
      document.getElementById('availableRooms').innerHTML = '<p style="text-align:center;color:red;">No rooms available.</p>';
    }
  } catch (err) {
    console.error(err);
    document.getElementById('availableRooms').innerHTML = '<p style="text-align:center;color:red;">Error fetching rooms from server</p>';
  }
}

function displayRooms(rooms) {
  const container = document.getElementById('availableRooms');
  container.innerHTML = '';

  rooms.forEach(room => {
    const card = document.createElement('div');
    card.className = 'room-card';

    const buttonHTML =
      room.status === "Available"
        ? `<button class="available" onclick="openBookingModal(${room.id}, '${room.name.replace(/'/g, "\\'")}')">Book & Pay</button>`
        : `<button class="booked" disabled>Booked</button>`;

    card.innerHTML = `
      <h3>${room.name}</h3>
      <p>Price: KES ${room.price * USD_TO_KES} / night</p>
      <p>Status: ${room.status}</p>
      ${buttonHTML}
    `;
    container.appendChild(card);
  });
}

// Open modal
function openBookingModal(roomId, roomName) {
  selectedRoomId = roomId;
  document.getElementById('modalRoomName').innerText = roomName;
  document.getElementById('guestName').value = '';
  document.getElementById('guestEmail').value = '';
  document.getElementById('checkin').value = '';
  document.getElementById('checkout').value = '';
  document.getElementById('bookingModal').style.display = 'flex';
}

// Close modal
function closeModal() {
  document.getElementById('bookingModal').style.display = 'none';
  selectedRoomId = null;
}

// Submit booking
async function submitBooking() {
  const name = document.getElementById('guestName').value.trim();
  const email = document.getElementById('guestEmail').value.trim();
  const checkin = document.getElementById('checkin').value;
  const checkout = document.getElementById('checkout').value;

  if (!name || !email || !checkin || !checkout) {
    return alert('All fields are required.');
  }

  const payload = { name, email, roomId: selectedRoomId, checkin, checkout };

  try {
    const res = await fetch('http://localhost:4242/book', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.success) {
      alert(`‚úÖ Room booked successfully!`);
      closeModal();
      fetchRooms();
    } else {
      alert('‚ùå Booking failed: ' + data.message);
    }
  } catch (err) {
    console.error(err);
    alert('‚ùå Booking failed. Check server logs.');
  }
}

// Close modal when clicking outside content
window.onclick = function(e) {
  if (e.target === document.getElementById('bookingModal')) closeModal();
}

// Load rooms on page load
fetchRooms();
</script>
</body>
</html>
